# Multi-stage image that bundles c2patool, the Node server, and the built React UI

# --- Stage 1: build c2patool
FROM rustlang/rust:nightly-slim AS c2pa-builder
RUN apt-get update && apt-get install -y git pkg-config libssl-dev curl make && rm -rf /var/lib/apt/lists/*
RUN git clone https://github.com/contentauth/c2pa-rs.git /c2pa-rs
WORKDIR /c2pa-rs
RUN cargo build --release && ls -l target/release/c2patool

# --- Stage 2: build client
FROM node:18-alpine AS client-builder
WORKDIR /client
COPY client/package.json client/vite.config.js ./
COPY client/index.html ./
COPY client/src ./src
RUN npm install && npm run build

# --- Stage 3: runtime
FROM node:18-alpine
WORKDIR /app

# c2patool binary
COPY --from=c2pa-builder /c2pa-rs/target/release/c2patool /usr/local/bin/c2patool

# Server + assets
COPY server.js ./
COPY manifest.json C2PA-TRUST-BUNDLE.pem ./
COPY --from=client-builder /client/dist ./client/dist

# Production config
ENV NODE_ENV=production
# Use local c2patool inside container
ENV C2PA_MODE=local
# Allow overriding manifest and trust bundle paths
ENV MANIFEST_PATH=/app/manifest.json
ENV TRUST_BUNDLE_PATH=/app/C2PA-TRUST-BUNDLE.pem
EXPOSE 8080
CMD ["node", "server.js"]
